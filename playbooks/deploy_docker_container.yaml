---
- name: Install dependencies
  hosts: docker_server
  tasks:
  - name: install system dependencies
    dnf:
      name: 
        - libselinux-python3
      state: latest
      #https://github.com/ansible/ansible/issues/67083   habria que ver en centos 7 el python3-dnf

- name: check if container is already running
  hosts: docker_server
  vars_files: "{{ project_path }}/vars/vars.yml"
  pre_tasks:
  - name: create build directory
    file: 
      path: /root/tmp/tomcat-tests-files
      state: directory
      owner: root
      group: root
      mode: '0755'
  - name: copy test file
    copy:
      src: "{{ project_path }}/files/tests.py"
      dest: /root/tmp/tomcat-tests-files
      owner: root
      group: root
      mode: '0644'
  - name: execute pytest script
    script: "{{ project_path }}/files/run_tests.py /root/tmp/tomcat-tests-files/tests.py {{ container_name }} {{ http_scheme }} {{ host }} {{ port }} {{ url_path }}" 
    register: pytest_execution
    args:
      executable: python3
    failed_when: no
    changed_when: no
  - debug:
      msg: "Role docker_container_builder_deployer will {{ 'not' if pytest_execution.rc==0 }} be executed"
  roles:
    - role: docker_container_builder_deployer 
      when: "pytest_execution.rc != 0"
  post_tasks:
    - name: "open port {{ host_map_port }} if needed"
      block:
        - name: execute pytest script
          script: "{{ project_path }}/files/run_tests.py /root/tmp/tomcat-tests-files/tests.py {{ container_name }} {{ http_scheme }} {{ host }} {{ port }} {{ url_path }}" 
          register: pytest_execution_2
          args:
            executable: python3
          failed_when: no
          changed_when: no
        - debug:
            msg: "Container was {{ 'not ' if pytest_execution_2.rc != 0 }}successfuly deployed"
      when: "pytest_execution.rc != 0"
